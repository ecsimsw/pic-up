## 20231025 Vultr S3 사용과 이미지 백업 정책

사용자 사진을 저장할 백업 스토리지로 Object storage 를 고민했고, Vultr 의 S3를 사용하게 되었다.
회사가 적당히 크면서도 가격이 저렴한게 가장 큰 선택 이유가 되었다.     

사용되는 Storage 와 Bandwidth 가 각각 1TB 라고 했을 때, AWS S3 (Standard) 는 월 24$, Vultr 의 S3 는 월 6$ 으로 훨씬 절약 할 수 있다.     
또 Vultr 는 단위 금액 충전식 결제가 가능해서 요금 과금 걱정이 없다는 것도 큰 장점으로 다가왔다. (테스트로 10$을 먼저 선결제했다.)     

물론 아쉽게도 확실히 회사가 작아서 그런지 AWS 보다 제공되는 Region 이 적고, 문서가 부족하는 문제가 있었다.    
다행히 Amazon S3 sdk 를 사용하여 CRUD 가 가능해 설정이나 개발하는데 큰 무리는 없었다.

### S3 Config

```java
@Configuration
public class S3Config {

    @Bean
    public AmazonS3 s3Client(
        @Value("${s3.vultr.host.url}") String hostUrl,
        @Value("${s3.vultr.host.region}") String region,
        @Value("${s3.vultr.credential.accessKey}") String accessKey,
        @Value("${s3.vultr.credential.secretKey}") String secretKey
    ) {
        AmazonS3ClientBuilder s3ClientBuilder = AmazonS3ClientBuilder.standard().withCredentials(
            new AWSStaticCredentialsProvider(new BasicAWSCredentials(accessKey, secretKey))
        );
        EndpointConfiguration endPoint = new EndpointConfiguration(hostUrl, region);
        s3ClientBuilder.setEndpointConfiguration(endPoint);
        return s3ClientBuilder.build();
    }
}
```

### BackUp strategy

최우선 규칙으로 'upload 는 반드시, delete 는 선택' 을 잡았다.     
업로드시에는 main storage 의 업로드 여부와 상관없이 실패 시 업로드 요청 자체를 실패로 여기도록 하는 반면 삭제시에는 제거 실패로 찌꺼기가 남아도 그렇게 큰 문제를 만들지 않겠다는 생각이었다.    

이렇게 하면 삭제 실패로 혹시 생길 수 있는 찌꺼기에 데이터 storage 비용은 조금 더 나오겠지만 적어도 데이터를 잃는 것에는 가장 안전하지 않을까 생각한다.     
추가로 main - backUp storage 사이에 싱크 문제가 있어 생길 수 있는 찌꺼기 파일들은   

#### 업로드

``` java
public ImageUploadResponse upload(String resourceKey, ImageFile imageFile) {
    mainStorage.create(resourceKey, imageFile);
    try {
        backUpStorage.create(resourceKey, imageFile);
        return new ImageUploadResponse(resourceKey, imageFile.getSize());
    } catch (Exception e) {
        residueRepository.save(Residue.from(resourceKey, MAIN_STORAGE, e.getMessage()));
        throw new StorageException("Failed to back up", e);
    }
}
```


