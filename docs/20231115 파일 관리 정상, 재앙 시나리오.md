# 20231115 파일 관리, 재앙 시나리오

작성 일 기준의 파일 읽기, 쓰기, 삭제 요청의 처리 과정과 그 과정에서 생길 수 있는 문제와 처리 시나리오를 정리한다.    

## 1. 파일 업로드

### 1-1. 정상 업로드 

<img width="1300" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/64c08541-718b-4901-b16f-dbe2011f09fe">

</br>

- Album server에서 RestTemplate 으로 Storage 서버에 파일 업로드를 요청한다.
- 업로드 요청 이벤트와 스토리지 기록 내용을 DB 에 기록한다.
- 사진 파일은 메인 스토리지 / 백업 스토리지 모두에 저장되어야 한다.
- 사진 파일은 암호화 되어야 한다.

</br>


### 1-2. 메인 스토리지 업로드 실패

<img width="1421" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/be1ddcbd-be06-4268-ae09-c6a82eee8bf9">

- 메인 스토리지 업로드 실패시에도 업로드 이벤트는 DB에 기록된다. 대신 저장된 스토리지가 없음이 함께 기록된다.

</br>

### 1-3. 메인 스토리지 성공, 백업 스토리지 업로드 실패 

<img width="1383" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/81f82503-f952-44d3-8b5e-4d2e5836ca6d">

- 백업 스토리지 업로드 실패 시 서버 문제로 응답한다.
- 이미 업로드 처리된 스토리지의 파일은 Message queue 에 기록되어 비동기 삭제 처리된다.

</br>

### 1-4. Storage 서버에서 업로드 실패

<img width="858" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/07087e54-03f1-407c-aefb-87200b92a938">

- Album 서버에서 Storage 서버로 업로드 요청시 서버가 다운되었거나 응답이 유효하지 않다면 서버 문제로 응답한다.
- 0.5초 간격으로 3회 재시도 한다.
- 재시도 이후에도 처리되지 않을 경우 에러 로깅하고 슬랙으로 알린다.

</br>

## 2. 파일 읽기

### 2-1. 정상 읽기

<img width="1103" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/3972944c-525f-48bc-9e54-198608aa64f8">

- 읽는 사용자의 읽기 권한을 확인한다.
- 스토리지에서 파일을 읽고 복호화한다.
- 파일은 메인 스토리지에서 먼저 읽고, 정상일 시 다음 백업 스토리지를 탐색하지 않는다.

</br>

### 2-2. 메인 스토리지에서 읽기 실패

<img width="1199" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/3e80bbf8-e409-4fe4-9469-6a8e724c83fd">

- 메인 스토리지에서 읽기 실패시 백업 스토리지에서 파일을 읽는다.
- 메인 스토리지에 파일이 없는 경우 로드한 파일을 메인 스토리지에 저장 후 응답한다.
- 파일 없음 외 메인 스토리지의 문제라면 로드한 파일을 바로 응답한다.

</br>

### 2-3. 백업 스토리지에서도 읽기 실패하는 경우

<img width="1168" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/e30f697c-f3b8-4844-a9a9-915801f49ad2">

- 메인과 백업 스토리지에서 모두 읽기 실패하는 경우 서버 에러를 응답한다.
- 읽기 실패 이유에 따라 파일 정보 (저장 스토리지)를 업데이트 한다.

</br>

## 3. 삭제

### 3-1. 정상 삭제

<img width="1347" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/5ebac0da-006e-4687-b6db-d8f573283f0c">

- Album에선 리소스 논리 삭제 후 Message queue에 제거할 리소스를 추가하고 사용자에게 바로 응답한다.
- Message queue에 제거할 리소스 추가시 5개 단위로 나눠 큐에 저장한다.
- Storage에선 Message queue에서 제거할 리소스를 가져와 삭제 처리한다.
- Storage에서 Message queue로부터 가져오는 Prefetch 수는 2이다.

</br>

### 3-2. 메시지 삭제 처리 실패 or 타임 아웃

<img width="1060" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/b07b4333-7bd7-472c-9d9a-8cd9d454bb06">

- 메시지 처리 도중 실패하는 경우 Message queue 에 NACK로 알린다.
- 처리 시간이 10분이 넘어가는 경우 타임 아웃 처리되어 Message queue에 알린다.
- 처리 실패의 경우 5번 재시도한다.
- 재시도 이후에도 처리가 실패되는 경우 Dead letter exchange - Dead letter queue 로 넘어가 처리 실패 로직이 처리된다.
- 현재 처리 Dead letter 처리 로직은 에러 로깅, 슬랙 알람 등 개발자가 직접 처리 할 수 있도록 기록하는 것을 최우선으로 한다.

</br>

### 3-3. 삭제시 메시지 브로커의 연결 문제

<img width="604" alt="image" src="https://github.com/ecsimsw/pic-up/assets/46060746/8428ba47-3f85-40aa-9439-db95934f87d8">

- 메시지 브로커와 연결과 관계없이 사용자의 파일이 논리 삭제되었다면 사용자에겐 정상 응답한다.
- 메시지 브로커와 연결 time out 은 5초로 한다.
- 메시지 브로커와의 연결을 실패하는 경우 5번 재시도 한다.
- 재시도 끝에도 처리 실패하는 경우 삭제 처리 실패한 파일과 사유, 시간을 기록하고 에러 로깅, 슬랙 알람한다.
